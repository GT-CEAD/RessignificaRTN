"0","FiltraSeries <- function(series_temporais_analise, rubricas, freq, avalia_parc=TRUE){"
"0","  library(lubridate)"
"0","  for (i in c(1:length(rubricas))) {"
"0","    if (avalia_parc) {"
"0","      serie_trabalho <- series_temporais_analise[grep(rubricas[i],series_temporais_analise$Rubrica),]"
"0","    }"
"0","    else {"
"0","      serie_trabalho <- series_temporais_analise[series_temporais_analise$Rubrica == rubricas[i],]"
"0","    }"
"0","    "
"0","    ano_ini <- as.numeric(substr(serie_trabalho$Data[1],1,4))"
"0","    mes_ini <- as.numeric(substr(serie_trabalho$Data[1],6,7))"
"0","    ano_fim<-as.numeric(substr(serie_trabalho$Data[NROW(serie_trabalho)],1,4))"
"0","    mes_fim<-as.numeric(substr(serie_trabalho$Data[NROW(serie_trabalho)],6,7))"
"0","    "
"0","    "
"0","    if (freq %in% c(12)){ #mensal"
"0","      per_ini <- mes_ini"
"0","      per_fim<-mes_fim"
"0","      "
"0","    }"
"0","    "
"0","    if (freq %in% c(1)){ #anual"
"0","      per_ini <- 1"
"0","      per_fim<-1"
"0","      "
"0","    }"
"0","    "
"0","    "
"0","    if (freq==4){#Trimestral"
"0","      per_ini<- as.numeric(substr(quarters(as.Date(serie_trabalho$Data[1])), 2, 2))"
"0","      per_fim<- as.numeric(substr(quarters(as.Date(serie_trabalho$Data[NROW(serie_trabalho)])), 2, 2))"
"0","    }"
"0","    "
"0","    if (freq==2){#Semestral"
"0","      per_ini<- semester(as.Date(serie_trabalho$Data[1]))"
"0","      per_fim<- semester(as.Date(serie_trabalho$Data[NROW(serie_trabalho)]))"
"0","    }"
"0","    "
"0","    "
"0","    "
"0","    if (i==1){"
"0","      series<- ts(serie_trabalho$Valor,start = c(ano_ini,per_ini),end = c(ano_fim,per_fim),frequency = freq)#,class=""mts"""
"0","  "
"0","    } else {"
"0","      series<- cbind(series,ts(serie_trabalho$Valor,start = c(ano_ini,per_ini),end = c(ano_fim,per_fim),frequency = freq))}"
"0","  }"
"0","  if (length(rubricas)>1) {colnames(series)<-rubricas}"
"0","  series"
"0","}"
"0","  "
"0","RotulaSeries<- function(graph,rotulos){"
"0","  library(magrittr)"
"0","  str<-"""""
"0","  for (rotulo in rotulos) {"
"0","    str<-paste0(str,""%>% dySeries(label ='"", rotulo,""')"")"
"0","    "
"0","  }"
"0","  "
"0","  view_graph<-paste0(graph,str)"
"0","  view_graph"
"0","  "
"0","}"
"0","GraficoSeries <- function(series,rubricas,rotulos, nome_grafico){"
"0","  library(magrittr)"
"0","  library(dygraphs) #Série temporal dinâmica"
"0","  "
"0","  y_min <- min(as.numeric(series))"
"0","  y_max <- max(as.numeric(series))"
"0","  "
"0","  series[series==0]<-NA"
"0","  "
"0","  "
"0","  dygraph(series,main = nome_grafico) %>%"
"0","        dyRangeSelector() %>%"
"0","        dyAxis(name= 'y',valueRange = c(y_min,y_max)) %>%"
"0","       dyLegend(show = 'follow', hideOnMouseOut = TRUE, width = 400)%>%"
"0","       dyOptions(connectSeparatedPoints = TRUE)%>%"
"0","        dyHighlight(highlightCircleSize = 5)"
"0","  # "
"0","  "
"0","  # graph<-paste0(""dygraph(series,main = nome_grafico) %>%  dyRangeSelector() %>%  dyAxis(name= 'y',valueRange = c("",y_min,"","",y_max,"")) %>%  dyLegend(show = 'follow', hideOnMouseOut = TRUE, width = 400)%>%  dyOptions(connectSeparatedPoints = TRUE) %>% dyOptions( drawGrid = FALSE) %>% dyHighlight(highlightCircleSize = 5)"")"
"0","  # eval(parse(text=RotulaSeries(graph,rotulos)))"
"0","}"
"0","ExtraiRubricasRaiz <- function(tipo_fluxo=3){"
"0","  load(""todas_series.Rdata"")"
"0","  if (tipo_fluxo == 1)  {serie<-series_temporais_analise_rec}"
"0","  if (tipo_fluxo == 2)  {serie<-series_temporais_analise_desp}"
"0","  if (tipo_fluxo == 3)  {serie<-rbind(series_temporais_analise_rec,series_temporais_analise_desp)}"
"0","  "
"0","  rubricas<-c(as.character(unique(serie$Rubrica)))"
"0","  rubrica_raiz <- c(numeric())"
"0","  "
"0","  for (i in 1:(length(rubricas)-1)){"
"0","    codigo_corr<- strsplit(rubricas[i],"" "")"
"0","    codigo_corr<- codigo_corr[[1]][1]"
"0","    ult_car<-substr(codigo_corr,nchar(codigo_corr),nchar(codigo_corr))"
"0","    if( ult_car!="".""){"
"0","      codigo_prox<- strsplit(rubricas[i+1],"" "") "
"0","      codigo_prox<- codigo_prox[[1]][1]"
"0","      nivel_corr<-sum(unlist(strsplit(codigo_corr,""""))==""."")"
"0","      nivel_prox<-sum(unlist(strsplit(codigo_prox,""""))==""."")"
"0","      if (nivel_corr >= nivel_prox){"
"0","        rubrica_raiz <- append(rubrica_raiz,rubricas[i])"
"0","        "
"0","      }"
"0","      "
"0","    }"
"0","    "
"0","    "
"0","  }"
"0","  if (tipo_fluxo!=1){rubrica_raiz <- append(rubrica_raiz,rubricas[length(rubricas)])}"
"0","  rubrica_raiz"
"0","  "
"0","}"
"0","calcula_valor_indexado<- function(serie_nominal,serie_indexador){"
"0","  join<-merge(x=serie_nominal, y=serie_indexador,by.x = c(""Data""), by.y = c(""Data""))"
"0","  join$valor<- join$Valor.x*join$Valor.y"
"0","  join<-join[,c(2,1,6)]"
"0","  names(join)<-names(serie_nominal)"
"0","  "
"0","  join"
"0","  "
"0","}"
"0","Trata_Outlier <- function(series){"
"0","library(strucchange)"
"0","library(forecast)"
"0","  "
"0","  for (s in(1:NCOL(series))){"
"0","    serie_trabalho<- series[,s]"
"0","    #Verifica os pontos que são outliers"
"0","    "
"0","    #Verifica se os pontos que são outliers são também outliers em uma estrutura específica. Se fizerem serão descartados"
"0","    serie_cus <- efp(serie_trabalho ~ 1, type = ""Rec-CUSUM"")"
"0","    bound <- boundary(serie_cus, alpha = 0.01)"
"0","    "
"0","    true_outlier <- c(numeric())"
"0","    #Trata estruturas acima de uma linha de fronteira"
"0","    pontos<-which(serie_cus$process>=bound)"
"0","    if (length(pontos)>0){"
"0","      q<- quantile(serie_trabalho[pontos])"
"0","      vec_outlier<- pontos[which(serie_trabalho[pontos]>q[4]*1.5)]"
"0","      if (length(vec_outlier)>0) {true_outlier<-c(true_outlier,vec_outlier)}"
"0","      vec_outlier<- pontos[which(serie_trabalho[pontos]<q[2]*0.5)]"
"0","      if (length(vec_outlier)>0) {true_outlier<-c(true_outlier,vec_outlier)}"
"0","      "
"0","    }"
"0","    "
"0","    "
"0","    #Trata estruturas abaixo de uma linha de fronteira"
"0","    pontos<-which(serie_cus$process<=-bound)"
"0","    if (length(pontos)>0){"
"0","      q<- quantile(serie_trabalho[pontos])"
"0","      vec_outlier<- pontos[which(serie_trabalho[pontos]>q[4]*1.5)]"
"0","      if (length(vec_outlier)>0) {true_outlier<-c(true_outlier,vec_outlier)}"
"0","      vec_outlier<- pontos[which(serie_trabalho[pontos]<q[2]*0.5)]"
"0","      if (length(vec_outlier)>0) {true_outlier<-c(true_outlier,vec_outlier)}"
"0","      "
"0","    }"
"0","    "
"0","    #Trata estruturas entre duas linhas de fronteira"
"0","    pontos<-which(serie_cus$process>=-bound&serie_cus$process<=bound)"
"0","    if (length(pontos)>0){"
"0","      q<- quantile(serie_trabalho[pontos])"
"0","      vec_outlier<- pontos[which(serie_trabalho[pontos]>q[4]*1.5)]"
"0","      if (length(vec_outlier)>0) {true_outlier<-c(true_outlier,vec_outlier)}"
"0","      vec_outlier<- pontos[which(serie_trabalho[pontos]<q[2]*0.5)]"
"0","      if (length(vec_outlier)>0) {true_outlier<-c(true_outlier,vec_outlier)}"
"0","      "
"0","    }"
"0","    "
"0","    if (length(true_outlier)>0){"
"0","      true_outlier<-true_outlier [order(true_outlier)]"
"0","      "
"0","      "
"0","      for (i in (1:length(true_outlier))){"
"0","        if (length(serie_trabalho[1:true_outlier[i]-1])>0){"
"0","          fit<-auto.arima(serie_trabalho[1:true_outlier[i]-1])"
"0","          serie_trabalho[true_outlier[i]] <- forecast(fit,h=1)$mean"
"0","          "
"0","        }"
"0","        "
"0","      }"
"0","      "
"0","      "
"0","    }"
"0","    "
"0","    if (s==1) {"
"0","      series_ajustadas<-serie_trabalho}"
"0","    else {"
"0","      series_ajustadas<-cbind(series_ajustadas,serie_trabalho)}"
"0","    #print(s)"
"0","    "
"0","    "
"0","    "
"0","  }"
"0","  "
"0","  colnames(series_ajustadas)<-colnames(series)"
"0","  series_ajustadas"
"0","}"
"0","Identifica_series_estacionarias<- function(series){"
"0","  library(stats)"
"0","  "
"0","  nomes_series<-c(character())"
"0","  vazio<-TRUE"
"0","  for (i in (1:NCOL(series))){"
"0","    #Verifica se tem ou não raiz unitária pelo método Phillips-Perron para as séries que não estão completamente zeradas"
"0","    if (sum(series[,i])>0){"
"0","      res_test<-PP.test(series[,i]) "
"0","      #Somente as séries que não têm raiz unitária serão incluídas na lista"
"0","      if (res_test$p.value <= 0.01){"
"0","        nomes_series<-c(nomes_series,colnames(series)[i])"
"0","        if (vazio){"
"0","          "
"0","          series_estacionarias<-series[,i]"
"0","          vazio<-FALSE"
"0","        } else{"
"0","          "
"0","          series_estacionarias<-cbind(series_estacionarias,series[,i])}"
"0","      }"
"0","    }"
"0","  }"
"0","  colnames(series_estacionarias)<-nomes_series"
"0","  series_estacionarias"
"0","}"
"0","acumula_12_meses <- function(series_temporais,rubricas,avalia_parc){"
"0","  library(zoo)"
"0","  "
"0","  serie_soma_12<- FiltraSeries(series_temporais,rubricas, 12,avalia_parc)"
"0","  serie_soma_12<-rollsum(serie_soma_12,12,align = ""right"")"
"0","  serie_soma_12"
"0","  "
"0","  "
"0","}"
"0","acumula_periodo<- function(series_temporais, periodo=""a""){"
"0","  library(magrittr)"
"0","  library(dplyr)"
"0","  "
"0","  series_temporais$ano <- substr(series_temporais$Data,1,4)"
"0","  series_temporais$mes <- substr(series_temporais$Data,6,7)"
"0","  "
"0","  "
"0","  if (periodo ==""a""){"
"0","    serie_acumulada<-series_temporais %>% "
"0","      group_by(Rubrica, ano) %>%"
"0","      mutate(acum=cumsum(Valor))"
"0","    serie_acumulada$Valor<-serie_acumulada$acum"
"0","    "
"0","    "
"0","  }"
"0","  "
"0","  if (periodo==""s"") {"
"0","    "
"0","    series_temporais$semestre<-NA"
"0","    series_temporais$semestre[which(series_temporais$mes %in% c(""01"",""02"",""03"",""04"",""05"",""06""))]<-""1"""
"0","    series_temporais$semestre[which(series_temporais$mes %in% c(""07"",""08"",""09"",""10"",""11"",""12""))]<-""2"""
"0","    "
"0","    serie_acumulada<-series_temporais %>% "
"0","      group_by(Rubrica, ano, semestre) %>%"
"0","      mutate(acum=cumsum(Valor))"
"0","    serie_acumulada$Valor<-serie_acumulada$acum"
"0","    "
"0","  }"
"0","  "
"0","  "
"0","  if (periodo==""t"") {"
"0","    "
"0","    series_temporais$trimestre<-NA"
"0","    series_temporais$trimestre[which(series_temporais$mes %in% c(""01"",""02"",""03""))]<-""1"""
"0","    series_temporais$trimestre[which(series_temporais$mes %in% c(""04"",""05"",""06""))]<-""2"""
"0","    series_temporais$trimestre[which(series_temporais$mes %in% c(""07"",""08"",""09""))]<-""3"""
"0","    series_temporais$trimestre[which(series_temporais$mes %in% c(""10"",""11"",""12""))]<-""3"""
"0","    "
"0","    serie_acumulada<-series_temporais %>% "
"0","      group_by(Rubrica, ano, trimestre) %>%"
"0","      mutate(acum=cumsum(Valor))"
"0","    serie_acumulada$Valor<-serie_acumulada$acum"
"0","    "
"0","    "
"0","  }"
"0","  "
"0","  "
"0","  serie_acumulada<-serie_acumulada[,c(1:3)]"
"0","  "
"0","  serie_acumulada"
"0","}"
"0","Grafico_selecao_usuario <- function(serie_trabalho,"
"0","                                    tipo_valor,"
"0","                                    tipo_per,"
"0","                                    rubricas, "
"0","                                    rotulos, "
"0","                                    nome_grafico,"
"0","                                    avalia_parc){"
"0","  freq<-12"
"0","  if (tipo_per==""t"") {freq=4}"
"0","  if (tipo_per==""s"") {freq=2}"
"0","  if (tipo_per==""a"") {freq=1}"
"0","  "
"0","  if (length(rubricas)==0){"
"0","    rubricas<-serie_trabalho$Rubrica[1]"
"0","    rotulos<-rubricas"
"0","  }"
"0","  "
"0","  #Verifica se foi selecionada séries nominal ou indexada"
"0","  if (tipo_valor==""2""){"
"0","    load(""todas_series.Rdata"")"
"0","    serie_nominal<- serie_trabalho"
"0","    serie_indexador<-series_temporais_analise_IPCA"
"0","    serie_trabalho<- calcula_valor_indexado(serie_nominal,serie_indexador)"
"0","  }"
"0","  "
"0","  # Verifica se foi selecionado opção mensal, 12 meses, anual, trimestral ou semestral"
"0","  if (tipo_per %in% c(""m"",""a"",""t"",""s"")){"
"0","    if (tipo_per!=""m"") {serie_trabalho<-Destaca_Periodo_Acumulado(serie_trabalho, tipo_per)}"
"0","    series_grafico<- FiltraSeries(serie_trabalho,rubricas,freq,avalia_parc)"
"0","  }else "
"0","    series_grafico <- acumula_12_meses(serie_trabalho,rubricas,avalia_parc)"
"0","  "
"0","  "
"0","  GraficoSeries(series_grafico,rubricas,rotulos, nome_grafico)"
"0","  "
"0","}"
"0","Destaca_Periodo_Acumulado <- function(serie_trabalho,tipo_per){"
"0","  serie_acumulada<-acumula_periodo(serie_trabalho,tipo_per)"
"0","  "
"0","  if (tipo_per==""t""){"
"0","    serie_destacada<- serie_acumulada[which(substr(serie_acumulada$Data,6,7)%in%c(""03"",""06"",""09"",""12"")),]"
"0","    "
"0","  }"
"0","  "
"0","  if (tipo_per==""s""){"
"0","    serie_destacada<- serie_acumulada[which(substr(serie_acumulada$Data,6,7)%in%c(""06"",""12"")),]"
"0","    "
"0","  }"
"0","  "
"0","  if (tipo_per==""a""){"
"0","    serie_destacada<- serie_acumulada[which(substr(serie_acumulada$Data,6,7)%in%c(""12"")),]"
"0","    "
"0","  }"
"0","  serie_destacada"
"0","}"
"0","Busca_Metadados <- function(rubricas,tipo_fluxo){"
"0","  if (tipo_fluxo == 1) { #Receitas"
"0","    metadados<- metadados_rec"
"0","  }"
"0","  "
"0","  if (tipo_fluxo == 2) { #Despesa"
"0","    metadados<- metadados_desp"
"0","  }"
"0","  "
"0","  if (tipo_fluxo == 3) { #Despesa"
"0","    metadados<- metadados_completo"
"0","  }"
"0","  "
"0","  metadados_buscados <- metadados[metadados$Rubrica%in%rubricas,]"
"0","  metadados_buscados"
"0","}"
"0","Visualiza_Metadados <- function(rubricas, tipo_fluxo){"
"0","  library(DT)"
"0","  "
"0","  if (length(rubricas)==0){"
"0","    if (tipo_fluxo==1){"
"0","      rubricas<- metadados_rec$Rubrica[1]"
"0","    }"
"0","    if (tipo_fluxo==2){"
"0","      rubricas<- metadados_desp$Rubrica[1]"
"0","    }"
"0","    "
"0","    "
"0","  }"
"0","  "
"0","  dados_tabela<- Busca_Metadados(rubricas,tipo_fluxo)"
"0","  "
"0","  datatable(dados_tabela,rownames = FALSE,extensions = 'Responsive')"
"0","  "
"0","  "
"0","}"
